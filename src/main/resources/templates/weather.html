<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>AIå¤©æ°” - æ™ºèƒ½å¤©æ°”æŸ¥è¯¢</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <a href="/" class="back-btn">â† è¿”å›é¦–é¡µ</a>
    
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¤ï¸ DeepSeek å¤©æ°”</h1>
            <p>é€šè¿‡AIè·å–åŸå¸‚å¤©æ°”ä¿¡æ¯ï¼Œæ™ºèƒ½å¤©æ°”åŠ©æ‰‹</p>
            <div class="provider-info" id="providerInfo">
                <span class="provider-badge" id="providerBadge">ğŸ–¥ï¸ æœ¬åœ° Ollama</span>
            </div>
        </div>
        
        <div class="main-content">
            <div class="form-container">
                <form id="weatherForm">
                    <div class="form-group">
                        <label class="form-label">ğŸ™ï¸ åŸå¸‚åç§°</label>
                        <input type="text" 
                               name="city" 
                               id="cityInput"
                               class="form-input" 
                               placeholder="è¯·è¾“å…¥åŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·..." 
                               required>
                    </div>
                    
                    <button type="submit" id="queryBtn" class="btn btn-primary">
                        ğŸ” æŸ¥è¯¢å¤©æ°”
                    </button>
                </form>
            </div>
            
            <div id="resultContainer" class="result-container" style="display: none;">
                <div class="result-title">
                    <span>ğŸŒ¡ï¸</span>
                    å¤©æ°”ä¿¡æ¯
                </div>
                <div id="resultContent" class="result-content"></div>
            </div>
        </div>
    </div>
    
    <div class="copyright">
        Â© 2025 <a href="http://yjmyzz.cnblogs.com" target="_blank">è©ææ ‘ä¸‹çš„æ¨è¿‡</a> - DeepSeek Demo
    </div>

    <!-- å¼•å…¥é€šç”¨AIæµå¼å¤„ç†åº“ -->
    <script src="/js/ai-stream.js"></script>

    <script>
        // åˆ›å»ºAIæµå¼å¤„ç†å™¨å®ä¾‹
        const aiHandler = new AIStreamHandler({
            // å¤©æ°”æŸ¥è¯¢ç‰¹å®šé…ç½®
            endpoint: '/weather/stream',
            
            // UIå…ƒç´ é…ç½®
            sendButton: document.getElementById('queryBtn'),
            resultContainer: document.getElementById('resultContainer'),
            resultContent: document.getElementById('resultContent'),
            scrollContainer: document.getElementById('resultContainer'),
            
            // æŒ‰é’®æ–‡æœ¬é…ç½®
            buttonTexts: {
                default: 'ğŸ” æŸ¥è¯¢å¤©æ°”',
                loading: 'æŸ¥è¯¢ä¸­...'
            },
            
            // çŠ¶æ€æ–‡æœ¬é…ç½®
            statusTexts: {
                connecting: 'æ­£åœ¨è¿æ¥å¤©æ°”æœåŠ¡...',
                connected: 'è¿æ¥æˆåŠŸï¼Œæ­£åœ¨æŸ¥è¯¢å¤©æ°”...',
                error: 'å¤©æ°”æœåŠ¡è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•',
                complete: 'æŸ¥è¯¢å®Œæˆ'
            },
            
            // é”™è¯¯å¤„ç†é…ç½®
            showErrorInResult: false,
            errorMessage: 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·é‡è¯•',
            
            // è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†
            onMessage: function(data, handler) {
                // å¤©æ°”æŸ¥è¯¢ä½¿ç”¨ç®€å•çš„æ–‡æœ¬è¿½åŠ 
                handler.appendContent(data);
            },
            
            // é”™è¯¯å¤„ç†
            onError: function(event, handler) {
                console.error('å¤©æ°”æŸ¥è¯¢æµé”™è¯¯:', event);
                console.log('EventSourceçŠ¶æ€:', handler.eventSource ? handler.eventSource.readyState : 'null');
                console.log('å½“å‰ç»“æœå†…å®¹é•¿åº¦:', handler.options.resultContent ? handler.options.resultContent.textContent.length : 0);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ­£å¸¸çš„è¿æ¥å…³é—­
                if (handler.eventSource && handler.eventSource.readyState === EventSource.CLOSED) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ”¶åˆ°äº†æ•°æ®ï¼Œå¦‚æœæ”¶åˆ°äº†æ•°æ®è¯´æ˜æŸ¥è¯¢æˆåŠŸ
                    const resultContent = handler.options.resultContent;
                    if (resultContent && resultContent.textContent.trim().length > 0) {
                        console.log('å¤©æ°”æŸ¥è¯¢æˆåŠŸå®Œæˆï¼Œå¿½ç•¥è¿æ¥å…³é—­é”™è¯¯');
                        return; // ä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    }
                }
                
                // åªæœ‰åœ¨çœŸæ­£çš„é”™è¯¯æ—¶æ‰æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                console.log('æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯');
                handler.options.resultContent.textContent += '\næŸ¥è¯¢å¤±è´¥ï¼Œè¯·é‡è¯•';
            },
            
            // å¼€å§‹å¤„ç†å›è°ƒ
            onStart: function(params) {
                console.log('å¼€å§‹å¤©æ°”æŸ¥è¯¢æµ:', params);
                // æ˜¾ç¤ºç»“æœå®¹å™¨
                AIUtils.showResultContainer('resultContainer', 'resultContent');
            },
            
            // ç»“æŸå¤„ç†å›è°ƒ
            onEnd: function() {
                console.log('å¤©æ°”æŸ¥è¯¢æµç»“æŸ');
            }
        });

        /**
         * å¼€å§‹å¤©æ°”æŸ¥è¯¢
         */
        function startWeatherQuery() {
            const city = AIUtils.getInputValue('cityInput');
            
            if (!city) {
                alert('è¯·è¾“å…¥åŸå¸‚åç§°');
                return;
            }
            
            // å¼€å§‹æµå¼å¤©æ°”æŸ¥è¯¢
            aiHandler.startStream({ city: city });
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å¤©æ°”é¡µé¢åŠ è½½å®Œæˆ');
            
            // è‡ªåŠ¨èšç„¦åˆ°åŸå¸‚è¾“å…¥æ¡†
            const input = document.getElementById('cityInput');
            if (input) {
                input.focus();
            }
            
            // æ›´æ–°æä¾›å•†å¾½ç« 
            AIUtils.updateProviderBadge('providerBadge');
            
            // è¡¨å•æäº¤å¤„ç†
            const form = document.getElementById('weatherForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                startWeatherQuery();
            });
        });
    </script>
</body>
</html> 